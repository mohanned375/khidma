<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المدير - منصة خدمة</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 1.1rem;
        }
        
        .providers-table {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .table-content {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .provider-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 2fr;
            gap: 15px;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        
        .provider-row:hover {
            background-color: #f8f9fa;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background-color: #d4edda;
            color: #155724;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
        }
        
        .btn-approve {
            background-color: #28a745;
            color: white;
        }
        
        .btn-reject {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-view {
            background-color: #007bff;
            color: white;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .refresh-btn {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .provider-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }
        
        .provider-details.show {
            display: block;
        }
        
        @media (max-width: 768px) {
            .provider-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .action-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1><i class="fas fa-cogs"></i> لوحة تحكم المدير</h1>
            <p>إدارة مقدمي الخدمات والطلبات</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalProviders">0</div>
                <div class="stat-label">إجمالي مقدمي الخدمات</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="pendingProviders">0</div>
                <div class="stat-label">في انتظار الموافقة</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="approvedProviders">0</div>
                <div class="stat-label">معتمد</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number" id="todayRegistrations">0</div>
                <div class="stat-label">تسجيلات اليوم</div>
            </div>
        </div>
        
        <div class="providers-table">
            <div class="table-header">
                <h2><i class="fas fa-users"></i> مقدمو الخدمات</h2>
                
                <button class="refresh-btn" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> تحديث البيانات
                </button>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>الحالة:</label>
                        <select id="statusFilter" onchange="filterProviders()">
                            <option value="">جميع الحالات</option>
                            <option value="pending">في انتظار الموافقة</option>
                            <option value="approved">معتمد</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>نوع الخدمة:</label>
                        <select id="serviceFilter" onchange="filterProviders()">
                            <option value="">جميع الخدمات</option>
                            <option value="بناء">بناء</option>
                            <option value="كهرباء">كهرباء</option>
                            <option value="سباكة">سباكة</option>
                            <option value="ميكانيكا">ميكانيكا</option>
                            <option value="نجارة">نجارة</option>
                            <option value="حرف">حرف</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>المدينة:</label>
                        <input type="text" id="cityFilter" placeholder="اكتب اسم المدينة" onkeyup="filterProviders()">
                    </div>
                    
                    <div class="filter-group">
                        <label>البحث:</label>
                        <input type="text" id="searchFilter" placeholder="ابحث بالاسم أو الهاتف" onkeyup="filterProviders()">
                    </div>
                </div>
            </div>
            
            <div class="table-content">
                <div class="provider-row" style="font-weight: bold; background-color: #f8f9fa;">
                    <div>الاسم</div>
                    <div>الخدمة</div>
                    <div>المدينة</div>
                    <div>الهاتف</div>
                    <div>الحالة</div>
                    <div>الإجراءات</div>
                </div>
                
                <div id="providersTableBody">
                    <!-- سيتم ملء البيانات هنا -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- نموذج عرض تفاصيل مقدم الخدمة -->
    <div id="providerDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('providerDetailsModal')">&times;</span>
            <h2>تفاصيل مقدم الخدمة</h2>
            <div id="providerDetailsContent">
                <!-- سيتم ملء التفاصيل هنا -->
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <script>
        // إعدادات Firebase (نفس الإعدادات من app.js)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        let db;
        let allProviders = [];
        let filteredProviders = [];
        
        // تهيئة Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.log('Firebase initialization failed:', error);
        }
        
        // تحميل البيانات عند بدء الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            loadAllProviders();
        });
        
        // تحميل جميع مقدمي الخدمات
        async function loadAllProviders() {
            try {
                if (db) {
                    const snapshot = await db.collection('providers').orderBy('registrationDate', 'desc').get();
                    allProviders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } else {
                    allProviders = JSON.parse(localStorage.getItem('providers') || '[]');
                }
                
                filteredProviders = [...allProviders];
                updateStats();
                displayProviders();
                
            } catch (error) {
                console.error('Error loading providers:', error);
                // استخدام بيانات تجريبية في حالة الخطأ
                allProviders = getSampleProviders();
                filteredProviders = [...allProviders];
                updateStats();
                displayProviders();
            }
        }
        
        // تحديث الإحصائيات
        function updateStats() {
            const total = allProviders.length;
            const pending = allProviders.filter(p => !p.approved).length;
            const approved = allProviders.filter(p => p.approved).length;
            
            // حساب تسجيلات اليوم
            const today = new Date().toDateString();
            const todayRegs = allProviders.filter(p => {
                const regDate = new Date(p.registrationDate).toDateString();
                return regDate === today;
            }).length;
            
            document.getElementById('totalProviders').textContent = total;
            document.getElementById('pendingProviders').textContent = pending;
            document.getElementById('approvedProviders').textContent = approved;
            document.getElementById('todayRegistrations').textContent = todayRegs;
        }
        
        // عرض مقدمي الخدمات
        function displayProviders() {
            const tbody = document.getElementById('providersTableBody');
            
            if (filteredProviders.length === 0) {
                tbody.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></i>
                        <h3>لا توجد نتائج</h3>
                        <p>لم يتم العثور على مقدمي خدمات مطابقين للفلاتر المحددة</p>
                    </div>
                `;
                return;
            }
            
            tbody.innerHTML = filteredProviders.map(provider => `
                <div class="provider-row">
                    <div>
                        <strong>${provider.name}</strong>
                        <br>
                        <small style="color: #666;">${formatDate(provider.registrationDate)}</small>
                    </div>
                    <div>${provider.service}</div>
                    <div>${provider.city}</div>
                    <div>
                        <a href="tel:${provider.phone}" style="color: #007bff; text-decoration: none;">
                            ${provider.phone}
                        </a>
                    </div>
                    <div>
                        <span class="status-badge ${provider.approved ? 'status-approved' : 'status-pending'}">
                            ${provider.approved ? 'معتمد' : 'في انتظار الموافقة'}
                        </span>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-small btn-view" onclick="viewProviderDetails('${provider.id}')">
                            <i class="fas fa-eye"></i> عرض
                        </button>
                        ${!provider.approved ? `
                            <button class="btn btn-small btn-approve" onclick="approveProvider('${provider.id}')">
                                <i class="fas fa-check"></i> موافقة
                            </button>
                            <button class="btn btn-small btn-reject" onclick="rejectProvider('${provider.id}')">
                                <i class="fas fa-times"></i> رفض
                            </button>
                        ` : `
                            <button class="btn btn-small btn-reject" onclick="rejectProvider('${provider.id}')">
                                <i class="fas fa-ban"></i> إلغاء
                            </button>
                        `}
                    </div>
                </div>
            `).join('');
        }
        
        // تصفية مقدمي الخدمات
        function filterProviders() {
            const statusFilter = document.getElementById('statusFilter').value;
            const serviceFilter = document.getElementById('serviceFilter').value;
            const cityFilter = document.getElementById('cityFilter').value.toLowerCase();
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            filteredProviders = allProviders.filter(provider => {
                let matches = true;
                
                if (statusFilter) {
                    if (statusFilter === 'pending' && provider.approved) matches = false;
                    if (statusFilter === 'approved' && !provider.approved) matches = false;
                }
                
                if (serviceFilter && provider.service !== serviceFilter) {
                    matches = false;
                }
                
                if (cityFilter && !provider.city.toLowerCase().includes(cityFilter)) {
                    matches = false;
                }
                
                if (searchFilter) {
                    const searchText = `${provider.name} ${provider.phone}`.toLowerCase();
                    if (!searchText.includes(searchFilter)) {
                        matches = false;
                    }
                }
                
                return matches;
            });
            
            displayProviders();
        }
        
        // الموافقة على مقدم خدمة
        async function approveProvider(providerId) {
            if (!confirm('هل أنت متأكد من الموافقة على هذا المقدم؟')) return;
            
            try {
                if (db) {
                    await db.collection('providers').doc(providerId).update({ approved: true });
                } else {
                    const providers = JSON.parse(localStorage.getItem('providers') || '[]');
                    const providerIndex = providers.findIndex(p => p.id === providerId);
                    if (providerIndex !== -1) {
                        providers[providerIndex].approved = true;
                        localStorage.setItem('providers', JSON.stringify(providers));
                    }
                }
                
                // تحديث البيانات المحلية
                const providerIndex = allProviders.findIndex(p => p.id === providerId);
                if (providerIndex !== -1) {
                    allProviders[providerIndex].approved = true;
                }
                
                filterProviders();
                updateStats();
                
                alert('تم اعتماد مقدم الخدمة بنجاح!');
                
            } catch (error) {
                console.error('Error approving provider:', error);
                alert('حدث خطأ أثناء اعتماد مقدم الخدمة');
            }
        }
        
        // رفض مقدم خدمة
        async function rejectProvider(providerId) {
            if (!confirm('هل أنت متأكد من رفض/إلغاء هذا المقدم؟ سيتم حذف بياناته نهائياً.')) return;
            
            try {
                if (db) {
                    await db.collection('providers').doc(providerId).delete();
                } else {
                    const providers = JSON.parse(localStorage.getItem('providers') || '[]');
                    const filteredProviders = providers.filter(p => p.id !== providerId);
                    localStorage.setItem('providers', JSON.stringify(filteredProviders));
                }
                
                // تحديث البيانات المحلية
                allProviders = allProviders.filter(p => p.id !== providerId);
                
                filterProviders();
                updateStats();
                
                alert('تم حذف مقدم الخدمة بنجاح!');
                
            } catch (error) {
                console.error('Error rejecting provider:', error);
                alert('حدث خطأ أثناء حذف مقدم الخدمة');
            }
        }
        
        // عرض تفاصيل مقدم الخدمة
        function viewProviderDetails(providerId) {
            const provider = allProviders.find(p => p.id === providerId);
            if (!provider) return;
            
            const content = document.getElementById('providerDetailsContent');
            content.innerHTML = `
                <div style="display: grid; gap: 15px;">
                    <div><strong>الاسم:</strong> ${provider.name}</div>
                    <div><strong>رقم الهاتف:</strong> 
                        <a href="tel:${provider.phone}" style="color: #007bff;">${provider.phone}</a>
                        <a href="https://wa.me/${formatPhoneNumber(provider.phone)}" target="_blank" style="margin-right: 10px; color: #25D366;">
                            <i class="fab fa-whatsapp"></i> واتساب
                        </a>
                    </div>
                    <div><strong>نوع الخدمة:</strong> ${provider.service}</div>
                    <div><strong>المدينة:</strong> ${provider.city}</div>
                    <div><strong>سنوات الخبرة:</strong> ${provider.experience || 'غير محدد'}</div>
                    <div><strong>وصف الخدمة:</strong> ${provider.description || 'لا يوجد وصف'}</div>
                    <div><strong>تاريخ التسجيل:</strong> ${formatDate(provider.registrationDate)}</div>
                    <div><strong>الحالة:</strong> 
                        <span class="status-badge ${provider.approved ? 'status-approved' : 'status-pending'}">
                            ${provider.approved ? 'معتمد' : 'في انتظار الموافقة'}
                        </span>
                    </div>
                </div>
            `;
            
            document.getElementById('providerDetailsModal').style.display = 'block';
        }
        
        // تحديث البيانات
        function refreshData() {
            loadAllProviders();
        }
        
        // إغلاق النموذج
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // تنسيق التاريخ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // تنسيق رقم الهاتف للواتساب
        function formatPhoneNumber(phone) {
            let cleaned = phone.replace(/\D/g, '');
            if (cleaned.startsWith('05')) {
                cleaned = '966' + cleaned.substring(1);
            } else if (cleaned.startsWith('5')) {
                cleaned = '966' + cleaned;
            } else if (!cleaned.startsWith('966')) {
                cleaned = '966' + cleaned;
            }
            return cleaned;
        }
        
        // بيانات تجريبية
        function getSampleProviders() {
            return [
                {
                    id: 'sample1',
                    name: 'أحمد محمد',
                    phone: '0501234567',
                    service: 'بناء',
                    city: 'الرياض',
                    description: 'مقاول بناء متخصص في المشاريع السكنية والتجارية',
                    experience: 10,
                    approved: true,
                    registrationDate: new Date(Date.now() - 86400000).toISOString()
                },
                {
                    id: 'sample2',
                    name: 'محمد علي',
                    phone: '0507654321',
                    service: 'كهرباء',
                    city: 'جدة',
                    description: 'فني كهربائي معتمد لجميع أعمال الكهرباء المنزلية والتجارية',
                    experience: 8,
                    approved: false,
                    registrationDate: new Date().toISOString()
                }
            ];
        }
        
        // إغلاق النماذج عند النقر خارجها
        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
